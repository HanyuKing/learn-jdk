@startuml
'https://plantuml.com/sequence-diagram
skin rose
autonumber

'---------------------------创建出库单--------------------------'

采购调拨单 -> 出库单: 创建
出库单 -> 出库单: 参数校验
出库单 -> 库存服务: 查询每个商品的库存(List<Long> ssuIdList)
出库单 <-- 库存服务: 返回每个ssuId的库存信息
出库单 -> 出库单: 校验库存
出库单 -> 商品中台: 查询商品信息(List<Long> ssuIdList)
出库单 <-- 商品中台: 返回每个ssuId的商品信息(pCode, pName)
出库单 -> 出库单: 补充附加字段\n比如: 出库单号、初始状态、商品信息等等

出库单 -> 出库单: 写出库单表\n写出库单明细表\n写出库单log表
note right : 事务

出库单 -> 库存服务: 库存预占

alt 库存预占失败
    出库单 <-- 库存服务: 库存预占失败
    出库单 -> 出库单: 逻辑删除出库单表、库单明细表记录
    采购调拨单 <-- 出库单: 结束
else 库存预占成功
    出库单 <-- 库存服务: 库存预占成功
    出库单 -> 出库单: 更新确认出库数量
    出库单 -> 出库单: 更新出库单状态为"待推送"
    note right : 定时任务重试此状态，直到推送成功
    出库单 -> RDC: 推出库单
    出库单 -> 出库单: 更新推RDC时间与状态
end

'---------------------------确认出库--------------------------'


@enduml